---
layout: post
title: Downloading ensemble data with rNOMADS
date: 2016-09-10
---

Weather forecasts are often generated by running not one simulation, but several simulations from perturbed initial conditions.
Forecast ensembles can be downloaded freely from the NOAA server as well.
They run 21 ensemble members with their 1 degree resolution model up to 16 days into the future.
Let's use the R package `rNOMADS` to download the latest temperature ensemble forecast for Berlin:


```r
# get latest download url and run date for ensemble forecast system 
library('rNOMADS')
url = tail(GetDODSDates('gens')$url, 1)
# [1] "http://nomads.ncep.noaa.gov:9090/dods/gens/gens20160910"
runs = GetDODSModelRuns(url)
run = tail(grep('_all_', runs$model.run, value=TRUE), 1)
# [1] "gep_all_06z"

# get Berlin coordinates and the closest grid point indices
library('ggmap')
lonlat = unlist(geocode('Berlin'))
lon = which.min( (seq(0, 360, by = 1) - lonlat[1])^2 ) - 1
lat = which.min( (seq(-90, 90, by = 1) - lonlat[2])^2 ) - 1

# grab data from NOMADS server
data = DODSGrab(
  model.url=url, 
  model.run=run, 
  variables='tmp2m', 
  time=c(0, 64), 
  lon=c(lon,lon),
  lat=c(lat,lat),
  ensembles=c(0,20))
str(data)
```

```
List of 9
 $ model.run.date: chr [1:1365] "20160910gep_all_00z" "20160910gep_all_00z" "20160910gep_all_00z" "20160910gep_all_00z" ...
 $ forecast.date : POSIXct[1:1365], format: "2016-09-10 01:00:00" "2016-09-10 07:00:00" ...
 $ variables     : chr [1:1365] "tmp2m" "tmp2m" "tmp2m" "tmp2m" ...
 $ levels        : chr [1:1365] "Level not defined" "Level not defined" "Level not defined" "Level not defined" ...
 $ ensembles     : num [1:1365] 1 1 1 1 1 1 1 1 1 1 ...
 $ lon           : num [1:1365] 13 13 13 13 13 13 13 13 13 13 ...
 $ lat           : num [1:1365] 53 53 53 53 53 53 53 53 53 53 ...
 $ value         : num [1:1365] 287 289 299 294 292 ...
 $ request.url   : chr "http://nomads.ncep.noaa.gov:9090/dods/gens/gens20160910/gep_all_00z.ascii?tmp2m[0:20][0:64][143:143][13:13]"
```

We get 21 ensemble members and 4 daily temperature forecast values up to 16 days ahead, amounting to `21 * (16 * 4 + 1) = 1365` values overall.
I like to represent ensemble data as matrices, with individual ensemble members represented as columns:

```r
times = sort(unique(data$forecast.date))
members = sort(unique(data$ensembles))
ens = matrix(NA_real_, ncol=length(members), nrow=length(times))
rownames(ens) = paste(times)
colnames(ens) = paste(members)
for (i in seq_along(data$value)) {
  time_ = paste(data$forecast.date[i])
  mem_ = paste(data$ensembles[i])
  ens[ time_, mem_ ] = data$value[i] - 273.15
}
plot(times, ens[,1], type='n', ylim=range(ens), ylab='Berlin temperature', main=data$model.run.date[1])
matlines(times, ens, lty=1, col='#00000055')
```

![Berlin temperature ensemble forecast]({{ site.baseurl}}/images/2016-09-10-berlintemp.png)

Looks like the summer will stay with the Berliners for another week.
Then temperatures are likely to drop.
But the forecast uncertainty is over 10 degrees at the end of the month, so we can't be sure.

The ensemble spread is very narrow for the first 5 days, indicating high confidence in the near-term forecast.
I don't really expect the observed temperature to fall inside the ensemble range, but such an analysis is for another day.

Until then, enjoy the summer while it lasts.


